#
# This is a simulation of a thin slab of Si, a photoconductor.
#
# 07/16/2020

# Experimental Variables

# Length of the silicon substrate, in microns.
set si_len = 100
# Material used as the dopant.
set dopant_m = phosphorus
# Concentration of the dopant.
set dopant_c = 1e15
# Type of the dopant.
if cond = ($dopant_m = phosphorus)
  set dopant_t=Nsub
else cond = ($dopant_m = boron)
  set dopant_t=Psub
if.end

# File Paths

# Name of the experiment.
set exp_name = "PC_${si_len}um_${dopant_t}${dopant_c}"
# Name of the structure file.
set file_str = "${exp_name}.str"
# Name of the log file for varying voltage.
set file_volt_log = "${exp_name}_voltage.log"
# Name of the log file for varying time.
set file_time_log = "${exp_name}_time.log"
# Name of the solution file.
set file_sta = "${exp_name}.sta"

# Start the Athena simulator, for creating the structure.
go athena

# Define the initial rectangular grid. Make it 1 micron wide, and a given
# length long.
line x loc=0 spac=0.5
line x loc=1 spac=0.5
line y loc=0 spac=0.1
line y loc=$si_len spac=0.1

# Define the initial substrate from the rectangular grid. Use silicon as
# the starting material, with a given dopant concentration.
# Since we specify phosphorus here, Athena will look up the c.resistivity value
# from the internal resistivity vs. concentration tables, which can be used for
# boron, phosphorus, arsenic, and antimony.
init silicon c.$dopant_m=$dopant_c orientation=100 two.d

# Length of the aluminum deposits, in microns.
set al_len = 1

# Deposit a layer of aluminum at the top.
deposit aluminum thick=$al_len division=5

# Deposit a layer of aluminum at the bottom.
structure flip.y
deposit aluminum thick=$al_len division=5
structure flip.y

# Define the upper aluminum material region as an electrode.
electrode name=cathode x=0.5 y=-0.1
# Define the lower aluminum material region as an electrode
electrode name=substrate x=0.5 y=$si_len+0.1

# Save the mesh to the structure file.
struct outf=$file_str

# Open the mesh in TonyPlot.
#tonyplot $file_str
#quit

# Start the Atlas simulator, for simulating the physics.
go atlas

# Read the mesh from the structure file.
mesh inf=$file_str

# Configure the electrodes as ohmic.
contact name=substrate neutral
contact name=cathode neutral
# Configure the electron and hole lifetime parameters.
# modify
material region=1 taun0=1e-7 taup0=1e-7
# Enable default models used for bipolar devices.
models bipolar
# Use Newton's method for solving, specifying the amount of carrier continuity
# equations to solve, whether to reduce electrode bias steps if the solution
# diverges, the amount of allowed outer loops, the amount of allowed trap
# procedures, and the maximum time-step.
method newton carriers=2 trap itlimit=20 maxtraps=10 dt.max=0.02e-9

# Introduce a Single Event Upset, with a given number of electron-hole pairs,
# moving with a given radius.
singleeventupset entrypoint="0,50" exitpoint="1,50" pcunits b.density=1.0e-4 \
    radialgauss radius=5 t0=2.e-11 tc=0

# Solve with all voltages set to 0.
solve initial
# Include the net charge in the output.
output charge
# Forward any voltage/current data generated by "solve" while varying the
# voltage to the log file.
log outf=$file_volt_log
# Solve with an increasingly high voltage applied to the substrate electrode.
solve vsubstrate=0 vstep=0.5 vfinal=1 name=substrate
# Save the structure and solution to the solution file.
save outf=$file_sta

# Forward any voltage/current data generated by "solve" while varying the
# time to the log file.
log outf=$file_time_log

solve tfinal=1e-8 tstep=1e-11
save outf=${exp_name}_after2e-008s.sta

loop steps = 6
  assign name = t_final n.value=1e-7 ratio=10
  assign name = t_step n.value=1e-10 ratio=10
  assign name = dt_max n.value=0.2e-9 ratio=10

  # Reconfigure the solving method.
  method newton carriers=2 trap itlimit=20 maxtraps=10 dt.max=$dt_max
  solve tfinal=$t_final tstep=$t_step
  save outf=${exp_name}_after${t_final}s.sta
l.end

# Open the solution in TonyPlot.
#tonyplot $file_sta $file_log
